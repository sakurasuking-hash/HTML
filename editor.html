<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<title>组合产品编辑页 - 后台原型</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<style>
		/* ---------- 全局样式（Google Material 风格简化版） ---------- */
		:root {
			--primary: #1976d2;
			--primary-dark: #115293;
			--primary-light: #e3f2fd;
			--accent: #ff9800;
			--bg: #f5f5f5;
			--surface: #ffffff;
			--text-main: #212121;
			--text-second: #757575;
			--border: #e0e0e0;
			--danger: #d32f2f;
			--success: #388e3c;
			--warning: #fbc02d;
		}

		* {
			box-sizing: border-box;
		}

		html, body {
			margin: 0;
			padding: 0;
			font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			background-color: var(--bg);
			color: var(--text-main);
		}

		body {
			display: flex;
			min-height: 100vh;
		}

		a {
			color: var(--primary);
			text-decoration: none;
		}

		a:hover {
			text-decoration: underline;
		}

		h1, h2, h3, h4 {
			margin: 0;
			font-weight: 500;
		}

		label {
			font-size: 13px;
			color: var(--text-second);
			display: inline-block;
			margin-bottom: 4px;
		}

		input[type="text"],
		input[type="number"],
		select,
		textarea {
			width: 100%;
			padding: 8px 12px;
			border-radius: 4px;
			border: 1px solid var(--border);
			font-size: 14px;
			outline: none;
			background-color: #fff;
			transition: border-color 0.15s ease, box-shadow 0.15s ease;
		}

		input[type="text"]:focus,
		input[type="number"]:focus,
		select:focus,
		textarea:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 2px rgba(25, 118, 210, 0.15);
		}

		input[disabled],
		select[disabled],
		textarea[disabled] {
			background-color: #fafafa;
			color: #9e9e9e;
		}

		textarea {
			min-height: 72px;
			resize: vertical;
		}

		.helper-text {
			font-size: 12px;
			color: var(--text-second);
			margin-top: 2px;
		}

		.helper-text.error {
			color: var(--danger);
		}

		.chip {
			display: inline-flex;
			align-items: center;
			padding: 2px 8px;
			border-radius: 16px;
			background-color: #eceff1;
			font-size: 12px;
			color: var(--text-second);
		}

		.chip.primary {
			background-color: var(--primary-light);
			color: var(--primary-dark);
		}

		/* ---------- 布局：侧边栏 + 顶部栏 + 内容 ---------- */
		.app-shell {
			display: flex;
			flex: 1;
		}

		.sidebar {
			width: 220px;
			background-color: #263238;
			color: #eceff1;
			display: flex;
			flex-direction: column;
		}

		.sidebar-header {
			padding: 16px 20px;
			font-size: 18px;
			font-weight: 500;
			border-bottom: 1px solid rgba(255, 255, 255, 0.08);
		}

		.sidebar-nav {
			padding: 8px 0;
		}

		.nav-section-title {
			padding: 8px 20px;
			font-size: 11px;
			text-transform: uppercase;
			color: rgba(255, 255, 255, 0.5);
		}

		.nav-item {
			display: flex;
			align-items: center;
			padding: 8px 20px;
			font-size: 14px;
			color: rgba(255, 255, 255, 0.85);
			cursor: default;
		}

		.nav-item.active {
			background-color: rgba(255, 255, 255, 0.12);
		}

		.nav-item .dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background-color: var(--accent);
			margin-right: 8px;
		}

		.main {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.topbar {
			height: 56px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 24px;
			background-color: var(--surface);
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
			position: sticky;
			top: 0;
			z-index: 10;
		}

		.topbar-title {
			display: flex;
			flex-direction: column;
		}

		.topbar-title h1 {
			font-size: 18px;
		}

		.topbar-title span {
			font-size: 12px;
			color: var(--text-second);
		}

		.breadcrumb {
			font-size: 12px;
			color: var(--text-second);
		}

		.breadcrumb span {
			color: var(--text-main);
		}

		.main-content {
			padding: 16px 24px 88px; /* 底部留出按钮条空间 */
			overflow-y: auto;
		}

		.section-card {
			background-color: var(--surface);
			border-radius: 8px;
			padding: 16px 20px 12px;
			margin-bottom: 16px;
			box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
		}

		.section-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 12px;
		}

		.section-header-left {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		.section-header h2 {
			font-size: 16px;
		}

		.section-subtitle {
			font-size: 12px;
			color: var(--text-second);
		}

		.section-badge {
			font-size: 11px;
			color: var(--primary-dark);
			background-color: var(--primary-light);
			border-radius: 999px;
			padding: 2px 8px;
		}

		.form-grid {
			display: grid;
			grid-template-columns: repeat(3, minmax(0, 1fr));
			gap: 16px 20px;
		}

		.form-grid-2 {
			display: grid;
			grid-template-columns: repeat(2, minmax(0, 1fr));
			gap: 16px 20px;
		}

		.form-field {
			display: flex;
			flex-direction: column;
		}

		.tag-ekp {
			display: inline-flex;
			align-items: center;
			gap: 4px;
			font-size: 11px;
			color: var(--text-second);
		}

		.tag-ekp span {
			padding: 0 6px;
			border-radius: 10px;
			border: 1px solid #b0bec5;
		}

		.tag-ekp .readonly {
			border-color: #bdbdbd;
			color: #9e9e9e;
		}

		/* ---------- 表格 & 权重区域 ---------- */
		.table-wrapper {
			border: 1px solid var(--border);
			border-radius: 8px;
			overflow: hidden;
			background-color: #fafafa;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			font-size: 13px;
		}

		thead {
			background-color: #eceff1;
		}

		th, td {
			padding: 8px 10px;
			border-bottom: 1px solid #e0e0e0;
			text-align: left;
			vertical-align: middle;
		}

		th {
			font-weight: 500;
			color: var(--text-second);
			font-size: 12px;
		}

		tr:last-child td {
			border-bottom: none;
		}

		tr:nth-child(even) td {
			background-color: #fafafa;
		}

		.cell-number {
			text-align: right;
			white-space: nowrap;
		}

		.table-footer {
			padding: 8px 10px;
			display: flex;
			align-items: center;
			justify-content: space-between;
			font-size: 12px;
			color: var(--text-second);
			background-color: #eceff1;
			border-top: 1px solid #e0e0e0;
		}

		.weight-ok {
			color: var(--success);
		}

		.weight-error {
			color: var(--danger);
			font-weight: 500;
		}

		/* ---------- 单选/开关 ---------- */
		.radio-group {
			display: flex;
			align-items: center;
			gap: 16px;
			font-size: 14px;
		}

		.radio-item {
			display: flex;
			align-items: center;
			gap: 4px;
			cursor: pointer;
		}

		.radio-item input {
			margin: 0;
		}

		/* ---------- 按钮 ---------- */
		.btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			gap: 4px;
			min-width: 80px;
			height: 32px;
			padding: 0 12px;
			border-radius: 16px;
			border: none;
			cursor: pointer;
			font-size: 13px;
			font-weight: 500;
			transition: background-color 0.15s ease, box-shadow 0.15s ease, transform 0.05s ease;
			background-color: transparent;
			color: var(--primary);
		}

		.btn:active {
			transform: translateY(1px);
		}

		.btn-primary {
			background-color: var(--primary);
			color: #fff;
			box-shadow: 0 2px 4px rgba(25, 118, 210, 0.4);
		}

		.btn-primary:hover {
			background-color: var(--primary-dark);
		}

		.btn-outlined {
			border: 1px solid var(--border);
			background-color: #fff;
			color: var(--text-main);
		}

		.btn-text {
			color: var(--text-second);
		}

		.btn-tonal {
			background-color: var(--primary-light);
			color: var(--primary-dark);
		}

		.btn-small {
			height: 28px;
			min-width: 64px;
			padding: 0 10px;
			font-size: 12px;
		}

		.btn-danger {
			color: #fff;
			background-color: var(--danger);
			box-shadow: 0 2px 4px rgba(211, 47, 47, 0.4);
		}

		.btn-danger:hover {
			background-color: #b71c1c;
		}

		.btn[disabled] {
			cursor: default;
			opacity: 0.6;
			box-shadow: none;
		}

		/* ---------- 底部操作条 ---------- */
		.footer-bar {
			position: fixed;
			left: 220px;
			right: 0;
			bottom: 0;
			height: 64px;
			background-color: var(--surface);
			box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.08);
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 24px;
			z-index: 20;
		}

		.footer-info {
			display: flex;
			flex-direction: column;
			font-size: 12px;
			color: var(--text-second);
		}

		.footer-info span:first-child {
			color: var(--text-main);
			font-weight: 500;
		}

		.footer-buttons {
			display: flex;
			align-items: center;
			gap: 8px;
		}

		/* ---------- 顶部提示条 ---------- */
		.banner {
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 8px 12px;
			border-radius: 8px;
			background-color: #fff8e1;
			color: #795548;
			font-size: 12px;
			margin-bottom: 12px;
		}

		.banner-icon {
			width: 20px;
			height: 20px;
			border-radius: 50%;
			display: inline-flex;
			align-items: center;
			justify-content: center;
			background-color: #ffe0b2;
		}

		.banner strong {
			font-size: 12px;
		}

		/* ---------- 弹窗 ---------- */
		.dialog-backdrop {
			position: fixed;
			inset: 0;
			background-color: rgba(0, 0, 0, 0.35);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 40;
		}

		.dialog {
			width: 420px;
			max-width: 90vw;
			background-color: var(--surface);
			border-radius: 12px;
			box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
			padding: 16px 20px 16px;
		}

		.dialog h3 {
			font-size: 16px;
			margin-bottom: 6px;
		}

		.dialog-content {
			font-size: 13px;
			color: var(--text-second);
			margin-bottom: 12px;
		}

		.dialog-actions {
			display: flex;
			justify-content: flex-end;
			gap: 8px;
			margin-top: 8px;
		}

		/* ---------- 顶部标签区域 ---------- */
		.header-tags {
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 12px;
			color: var(--text-second);
		}

		.status-chip {
			padding: 2px 8px;
			border-radius: 999px;
			font-size: 11px;
			font-weight: 500;
		}

		.status-draft {
			background-color: #e3f2fd;
			color: #1565c0;
		}

		.status-published {
			background-color: #e8f5e9;
			color: #2e7d32;
		}

		.status-offline {
			background-color: #ffebee;
			color: #c62828;
		}

		.badge-pill {
			border-radius: 999px;
			background-color: #eceff1;
			padding: 2px 8px;
		}

		/* ---------- 简单响应式 ---------- */
		@media (max-width: 960px) {
			.sidebar {
				display: none;
			}
			.footer-bar {
				left: 0;
			}
			.form-grid,
			.form-grid-2 {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>
<body>
	<div class="app-shell">
		<!-- 左侧菜单：策略管理平台 → 产品列表 → 编辑 -->
		<aside class="sidebar">
			<div class="sidebar-header">
				策略管理平台
			</div>
			<div class="sidebar-nav">
				<div class="nav-section-title">产品管理</div>
				<div class="nav-item">
					<span class="dot"></span>
					<span>产品列表</span>
				</div>
				<div class="nav-item active">
					<span class="dot"></span>
					<span>组合产品编辑</span>
				</div>
				<div class="nav-item">
					<span class="dot"></span>
					<span>系列配置</span>
				</div>
				<div class="nav-section-title">系统配置</div>
				<div class="nav-item">
					<span class="dot"></span>
					<span>风控与结算</span>
				</div>
			</div>
		</aside>

		<main class="main">
			<!-- 顶部栏 -->
			<header class="topbar">
				<div class="topbar-title">
					<h1>组合产品编辑</h1>
					<div class="header-tags">
						<div class="breadcrumb">
							策略管理平台 / <span>产品列表</span> / 组合产品编辑
						</div>
						<span class="status-chip status-draft" id="statusChip">草稿</span>
						<span class="badge-pill">产品编号：<span id="prodIdTop">WK001220251022</span></span>
					</div>
				</div>
				<div>
					<button class="btn btn-text" id="backToListBtn">返回列表</button>
				</div>
			</header>

			<!-- 页面主体 -->
			<div class="main-content">
				<!-- 说明 Banner -->
				<div class="banner" id="publishWarningBanner">
					<div class="banner-icon">!</div>
					<div>
						<strong>提示：</strong>
						<span>发布后将对前端生效，部分字段不可随意修改。建议先保存草稿，再进行发布操作。</span>
					</div>
				</div>

				<!-- 4.1 基础信息 -->
				<section class="section-card">
					<div class="section-header">
						<div class="section-header-left">
							<h2>基础信息</h2>
							<span class="section-badge">4.1 通用字段（部分来自 EKP）</span>
						</div>
						<div class="section-subtitle">
							由 EKP 提交后自动带入，可在此查看与补充必要信息
						</div>
					</div>

					<div class="form-grid">
						<div class="form-field">
							<label for="prodName">产品名称 *</label>
							<input type="text" id="prodName" value="矿金优选12号-燃料油FU" />
							<div class="helper-text">
								<span class="tag-ekp">
									<span>EKP</span>
									<span>可在此修改名称展示</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="prodId">产品编号</label>
							<input type="text" id="prodId" value="WK001220251022" disabled />
							<div class="helper-text">
								<span class="tag-ekp">
									<span class="readonly">EKP 不可修改</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="riskLevel">风险等级</label>
							<input type="text" id="riskLevel" value="R3" disabled />
							<div class="helper-text">
								<span class="tag-ekp">
									<span class="readonly">EKP 不可修改，影响前端展示与适配客户等级</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="prodType">产品类型</label>
							<input type="text" id="prodType" value="量化信号类" disabled />
							<div class="helper-text">
								<span class="tag-ekp">
									<span class="readonly">EKP 不可修改，用于分类统计与权限控制</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="prodOwner">产品出品人</label>
							<input type="text" id="prodOwner" value="五矿期货投资咨询团队" disabled />
							<div class="helper-text">
								<span class="tag-ekp">
									<span class="readonly">EKP 不可修改，用于前端展示与合规披露</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="prodLevel">产品等级</label>
							<input type="text" id="prodLevel" value="矿金优选(R3)" disabled />
							<div class="helper-text">
								<span class="tag-ekp">
									<span class="readonly">EKP 不可修改，对应客户分层权益</span>
								</span>
							</div>
						</div>

						<div class="form-field">
							<label for="isSigned">是否签约产品 *</label>
							<select id="isSigned">
								<option value="">请选择</option>
								<option value="yes" selected>是</option>
								<option value="no">否</option>
							</select>
							<div class="helper-text">
								用于后续签约流程与客户服务权益判断
							</div>
						</div>

						<div class="form-field">
							<label for="priceType">价格类型 *</label>
							<select id="priceType">
								<option value="">请选择</option>
								<option value="free">免费</option>
								<option value="one-time">单次购买</option>
								<option value="monthly" selected>按月订阅</option>
							</select>
							<div class="helper-text">
								与前端展示价格、订阅逻辑保持一致
							</div>
						</div>

						<div class="form-field">
							<label for="price">价格（元） *</label>
							<input type="number" id="price" min="0" step="0.01" value="999.00" />
							<div class="helper-text">
								请输入含税价格，前端按月展示
							</div>
						</div>

						<div class="form-field">
							<label for="discountPrice">优惠价格（元）</label>
							<input type="number" id="discountPrice" min="0" step="0.01" placeholder="选填，如活动折扣价" />
							<div class="helper-text">
								可为空；填写后在前端展示“原价 + 优惠价”
							</div>
						</div>

						<div class="form-field" style="grid-column: span 3;">
							<label for="intro">产品简介 *</label>
							<textarea id="intro" placeholder="请简要说明产品内容、适用人群、核心策略思路等">
针对燃料油（FU）的量化信号组合策略，基于多因子模型与风险控制规则生成交易信号，为客户提供中短期趋势跟踪服务。
							</textarea>
							<div class="helper-text">
								建议 50～200 字，将在前端详情页中展示
							</div>
						</div>
					</div>
				</section>

				<!-- 4.2 拓展信息 -->
				<section class="section-card">
					<div class="section-header">
						<div class="section-header-left">
							<h2>拓展信息</h2>
							<span class="section-badge">4.2 展示结构与组合类型</span>
						</div>
						<div class="section-subtitle">
							影响产品在前端的分组方式与后续组合配置能力
						</div>
					</div>

					<div class="form-grid-2">
						<div class="form-field">
							<label for="series">所属系列 *</label>
							<select id="series">
								<option value="">请选择系列</option>
								<option value="youxuan" selected>矿金优选 (R3)</option>
								<option value="zhixuan">矿金智选 (R3)</option>
								<option value="dingji">矿鼎进阶 (R4)</option>
							</select>
							<div class="helper-text">
								绑定到已有系列，用于签约和前端分组展示
							</div>
						</div>

						<div class="form-field">
							<label for="prodForm">产品形式 *</label>
							<select id="prodForm">
								<option value="">请选择</option>
								<option value="single">单品种策略</option>
								<option value="combo" selected>组合策略</option>
								<option value="thsy">同花顺指标</option>
							</select>
							<div class="helper-text">
								量化产品可选：单品种策略 / 组合策略 / 同花顺
							</div>
						</div>

						<div class="form-field" id="comboTypeField">
							<label for="comboType">组合类型 *</label>
							<select id="comboType">
								<option value="">请选择组合类型</option>
								<option value="type1" selected>类型 1 · 权重 + 份额制</option>
								<option value="type2">类型 2 · 权重 + 手数制</option>
								<option value="type3">类型 3 · 自定义规则</option>
							</select>
							<div class="helper-text">
								不同类型对应不同的结算与分配逻辑
							</div>
						</div>
					</div>
				</section>

				<!-- 4.2.2 量化产品基本信息（仅组合策略 / 类型1） -->
				<section class="section-card" id="quantBasicSection">
					<div class="section-header">
						<div class="section-header-left">
							<h2>量化产品基本信息</h2>
							<span class="section-badge">4.2.2 组合策略 · 类型 1</span>
						</div>
						<div class="section-subtitle">
							总权益 / 净值 / 份额等由创建与结算系统维护，当前仅展示
						</div>
					</div>

					<div class="form-grid-2">
						<div class="form-field">
							<label for="totalEquity">总权益（元）</label>
							<input type="number" id="totalEquity" value="1000000" disabled />
							<div class="helper-text">
								初始创建时录入，后续仅通过「入金 / 减资」调整
							</div>
						</div>

						<div class="form-field">
							<label for="nav">净值</label>
							<input type="number" id="nav" value="1.12" step="0.0001" disabled />
							<div class="helper-text">
								默认初始净值 = 1.0，后续由结算系统计算回写
							</div>
						</div>

						<div class="form-field">
							<label for="share">份额</label>
							<input type="number" id="share" value="892857.14" disabled />
							<div class="helper-text">
								初始 = 总权益 / 净值，后续随入金与减资自动调整
							</div>
						</div>
					</div>
				</section>

				<!-- 4.2.3 组合详情（量化策略组合） -->
				<section class="section-card" id="comboDetailSection">
					<div class="section-header">
						<div class="section-header-left">
							<h2>组合详情（量化策略组合）</h2>
							<span class="section-badge">4.2.3 权重配置与入金</span>
						</div>
						<div class="section-subtitle">
							每一行代表组合中的一条单腿策略，可配置权重与查看分配权益
						</div>
						<div style="display:flex;align-items:center;gap:8px;">
							<button class="btn btn-tonal btn-small" id="editLegsBtn">编辑组合</button>
							<button class="btn btn-primary btn-small" id="depositBtn">入金</button>
						</div>
					</div>

					<!-- 权重分配类型 -->
					<div style="margin-bottom: 8px;">
						<label>权重分配类型</label>
						<div class="radio-group" id="weightTypeGroup">
							<label class="radio-item">
								<input type="radio" name="weightType" value="equal" checked />
								<span>等权</span>
							</label>
							<label class="radio-item">
								<input type="radio" name="weightType" value="custom" />
								<span>自定义</span>
							</label>
						</div>
						<div class="helper-text" id="weightHint">
							等权：根据启用策略数量自动均分权重，新增 / 删除子腿时自动更新
						</div>
					</div>

					<!-- 策略列表表格 -->
					<div class="table-wrapper">
						<table>
							<thead>
								<tr>
									<th style="width: 80px;">单腿品种</th>
									<th style="width: 120px;">单腿产品 ID</th>
									<th style="width: 90px;">Cmb_id</th>
									<th style="width: 110px;">组合产品 ID</th>
									<th style="width: 100px; text-align:right;">权益（元）</th>
									<th style="width: 120px; text-align:right;">品种权重比例</th>
									<th style="width: 80px;">状态</th>
								</tr>
							</thead>
							<tbody id="legsTbody">
								<tr data-leg-id="1">
									<td>FU</td>
									<td>LEG001</td>
									<td>CMB001</td>
									<td>WK001220251022</td>
									<td class="cell-number" data-equity="400000">400,000</td>
									<td class="cell-number">
										<input type="number" class="weight-input" data-default="33.33" value="33.33" step="0.01" style="width:70px;text-align:right;" disabled />%
									</td>
									<td><span class="chip primary">启用</span></td>
								</tr>
								<tr data-leg-id="2">
									<td>J</td>
									<td>LEG002</td>
									<td>CMB001</td>
									<td>WK001220251022</td>
									<td class="cell-number" data-equity="350000">350,000</td>
									<td class="cell-number">
										<input type="number" class="weight-input" data-default="33.33" value="33.33" step="0.01" style="width:70px;text-align:right;" disabled />%
									</td>
									<td><span class="chip primary">启用</span></td>
								</tr>
								<tr data-leg-id="3">
									<td>RB</td>
									<td>LEG003</td>
									<td>CMB001</td>
									<td>WK001220251022</td>
									<td class="cell-number" data-equity="250000">250,000</td>
									<td class="cell-number">
										<input type="number" class="weight-input" data-default="33.34" value="33.34" step="0.01" style="width:70px;text-align:right;" disabled />%
									</td>
									<td><span class="chip primary">启用</span></td>
								</tr>
							</tbody>
						</table>
						<div class="table-footer">
							<div>
								当前组合总权益：<strong id="comboEquityDisplay">1,000,000</strong> 元
							</div>
							<div id="weightSummary" class="weight-ok">
								权重总和：<strong>100.00%</strong>
							</div>
						</div>
					</div>
				</section>

				<!-- 底部验证提示（示例） -->
				<section class="section-card" id="validationSection" style="display: none;">
					<div class="section-header">
						<div class="section-header-left">
							<h2>发布前校验</h2>
							<span class="section-badge">4.4 关键规则</span>
						</div>
						<div class="section-subtitle">
							仅在存在错误或缺失信息时展示
						</div>
					</div>
					<div id="validationMessages" class="helper-text error">
						<!-- 由 JS 动态填充 -->
					</div>
				</section>
			</div>

			<!-- 底部操作栏：保存 / 发布 / 取消 -->
			<footer class="footer-bar">
				<div class="footer-info">
					<span id="statusText">当前状态：草稿（未发布）</span>
					<span id="autosaveText">最近保存：尚未保存</span>
				</div>
				<div class="footer-buttons">
					<button class="btn btn-text" id="cancelBtn">取消</button>
					<button class="btn btn-outlined" id="saveBtn">保存</button>
					<button class="btn btn-primary" id="publishBtn">发布</button>
				</div>
			</footer>
		</main>
	</div>

	<!-- 入金弹窗 -->
	<div class="dialog-backdrop" id="depositDialog">
		<div class="dialog">
		     <h3>组合入金</h3>
		     <div class="dialog-content">
				<p>当前组合产品：<strong id="dialogProdName">矿金优选12号-燃料油FU</strong></p>
				<p>当前总权益：<strong id="currentEquityText">1,000,000</strong> 元</p>
				<div class="form-field" style="margin-top: 8px;">
					<label for="depositAmount">本次入金金额（元）</label>
					<input type="number" id="depositAmount" min="0" step="1000" value="100000" />
					<div class="helper-text">
						入金后系统将按当前权重比例同步更新各子腿权益
					</div>
					<div class="helper-text error" id="depositError" style="display:none;">
						请输入大于 0 的入金金额
					</div>
				</div>
		     </div>
		     <div class="dialog-actions">
				<button class="btn btn-text" id="cancelDepositBtn">取消</button>
				<button class="btn btn-primary" id="confirmDepositBtn">确认入金</button>
		     </div>
		</div>
	</div>

	<!-- 取消编辑弹窗 -->
	<div class="dialog-backdrop" id="leaveDialog">
		<div class="dialog">
			<h3>放弃未保存修改？</h3>
			<div class="dialog-content">
				检测到当前页面存在未保存的修改。若直接离开，本次修改内容将不会保留。
			</div>
			<div class="dialog-actions">
				<button class="btn btn-text" id="stayEditingBtn">继续编辑</button>
				<button class="btn btn-danger" id="confirmLeaveBtn">确认离开</button>
			</div>
		</div>
	</div>

	<!-- 发布确认弹窗 -->
	<div class="dialog-backdrop" id="publishDialog">
		<div class="dialog">
			<h3>确认发布该产品？</h3>
			<div class="dialog-content" id="publishDialogContent">
				<p>发布后将对前端生效，部分字段（产品类型、出品人等）不可随意修改。</p>
				<p>系统将校验必填项及组合权重总和是否为 100%。</p>
			</div>
			<div class="dialog-actions">
				<button class="btn btn-text" id="cancelPublishBtn">取消</button>
				<button class="btn btn-primary" id="confirmPublishBtn">确认发布</button>
			</div>
		</div>
	</div>

	<script>
		// ------------------ 简单状态 ------------------
		let hasUnsavedChanges = false;
		let currentStatus = "draft"; // draft / published / offline
		let lastSavedAt = null;

		const weightTypeGroup = document.getElementById("weightTypeGroup");
		const weightHint = document.getElementById("weightHint");
		const legsTbody = document.getElementById("legsTbody");
		const weightSummary = document.getElementById("weightSummary");
		const comboEquityDisplay = document.getElementById("comboEquityDisplay");
		const totalEquityInput = document.getElementById("totalEquity");
		const depositDialog = document.getElementById("depositDialog");
		const depositAmountInput = document.getElementById("depositAmount");
		const depositError = document.getElementById("depositError");
		const currentEquityText = document.getElementById("currentEquityText");
		const statusText = document.getElementById("statusText");
		const autosaveText = document.getElementById("autosaveText");
		const leaveDialog = document.getElementById("leaveDialog");
		const publishDialog = document.getElementById("publishDialog");
		const statusChip = document.getElementById("statusChip");
		const quantBasicSection = document.getElementById("quantBasicSection");
		const comboDetailSection = document.getElementById("comboDetailSection");
		const validationSection = document.getElementById("validationSection");
		const validationMessages = document.getElementById("validationMessages");
		const prodFormSelect = document.getElementById("prodForm");
		const comboTypeSelect = document.getElementById("comboType");
		const publishWarningBanner = document.getElementById("publishWarningBanner");
		const prodIdTop = document.getElementById("prodIdTop");
		const prodIdInput = document.getElementById("prodId");

		// 顶部产品编号同步
		if (prodIdInput && prodIdTop) {
			prodIdTop.textContent = prodIdInput.value;
		}

		// ------------------ 通用小工具 ------------------
		function markChanged() {
			hasUnsavedChanges = true;
			if (lastSavedAt) {
				autosaveText.textContent = "最近保存：" + lastSavedAt + "（有未保存更改）";
			} else {
				autosaveText.textContent = "最近保存：尚未保存（有未保存更改）";
			}
		}

		function formatNumber(num) {
			if (num === null || num === undefined || isNaN(num)) return "";
			return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}

		function nowTimeString() {
			const d = new Date();
			const yyyy = d.getFullYear();
			const mm = String(d.getMonth() + 1).padStart(2, "0");
			const dd = String(d.getDate()).padStart(2, "0");
			const hh = String(d.getHours()).padStart(2, "0");
			const mi = String(d.getMinutes()).padStart(2, "0");
			return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
		}

		function openDialog(el) {
			el.style.display = "flex";
		}

		function closeDialog(el) {
			el.style.display = "none";
		}

		// ------------------ 权重相关 ------------------
		function getWeightInputs() {
			return Array.from(document.querySelectorAll(".weight-input"));
		}

		function updateWeightSummary() {
			const inputs = getWeightInputs();
			let sum = 0;
			inputs.forEach((inp) => {
				const val = parseFloat(inp.value);
				if (!isNaN(val)) sum += val;
			});
			const rounded = Math.round(sum * 100) / 100;
			const isOk = Math.abs(rounded - 100) < 0.01;

			weightSummary.innerHTML = `权重总和：<strong>${rounded.toFixed(2)}%</strong>`;
			weightSummary.className = isOk ? "weight-ok" : "weight-error";

			return isOk;
		}

		function applyEqualWeight() {
			const inputs = getWeightInputs();
			if (!inputs.length) return;
			const base = 100 / inputs.length;
			let total = 0;
			inputs.forEach((inp, index) => {
				let val = index === inputs.length - 1 ? (100 - total) : base;
				val = Math.round(val * 100) / 100;
				inp.value = val.toFixed(2);
				inp.dataset.default = inp.value;
				total += val;
			});
			updateWeightSummary();
		}

		function setWeightType(type) {
			const inputs = getWeightInputs();
			if (type === "equal") {
				inputs.forEach((inp) => {
					inp.disabled = true;
				});
				weightHint.textContent = "等权：根据启用策略数量自动均分权重，新增 / 删除子腿时自动更新";
				applyEqualWeight();
			} else {
				inputs.forEach((inp) => {
					inp.disabled = false;
				});
				weightHint.textContent = "自定义：可逐行编辑权重，发布前需保证所有启用子腿权重和 = 100%";
				updateWeightSummary();
			}
		}

		// 监听权重类型切换
		weightTypeGroup.addEventListener("change", function (e) {
			if (e.target.name === "weightType") {
				const type = e.target.value;
				setWeightType(type);
				markChanged();
			}
		});

		// 监听权重输入改变
		legsTbody.addEventListener("input", function (e) {
			if (e.target.classList.contains("weight-input")) {
				updateWeightSummary();
				markChanged();
			}
		});

		// 初始化等权
		setWeightType("equal");

		// ------------------ 入金逻辑 ------------------
		document.getElementById("depositBtn").addEventListener("click", function () {
			const current = parseFloat(totalEquityInput.value || "0");
			currentEquityText.textContent = formatNumber(current);
			depositAmountInput.value = "100000";
			depositError.style.display = "none";
			openDialog(depositDialog);
		});

		document.getElementById("cancelDepositBtn").addEventListener("click", function () {
			closeDialog(depositDialog);
		});

		document.getElementById("confirmDepositBtn").addEventListener("click", function () {
			const amount = parseFloat(depositAmountInput.value || "0");
			if (isNaN(amount) || amount <= 0) {
				depositError.style.display = "block";
				return;
			}
			depositError.style.display = "none";

			// 更新总权益
			let currentEquity = parseFloat(totalEquityInput.value || "0");
			currentEquity += amount;
			totalEquityInput.value = currentEquity.toFixed(2);
			comboEquityDisplay.textContent = formatNumber(currentEquity);
			currentEquityText.textContent = formatNumber(currentEquity);

			// 按当前权重比例更新每行权益（仅展示层）
			const inputs = getWeightInputs();
			inputs.forEach((inp) => {
				const tr = inp.closest("tr");
				const equityCell = tr.querySelector("[data-equity]");
				const weight = parseFloat(inp.value || "0");
				const newEq = (currentEquity * weight) / 100;
				equityCell.dataset.equity = newEq.toFixed(2);
				equityCell.textContent = formatNumber(Math.round(newEq));
			});

			markChanged();
			closeDialog(depositDialog);
		});

		// ------------------ 保存 & 取消 ------------------
		document.getElementById("saveBtn").addEventListener("click", function () {
			// 简单必填校验（只展示提示，不做复杂逻辑）
			const prodName = document.getElementById("prodName").value.trim();
			const isSignedVal = document.getElementById("isSigned").value;
			const priceTypeVal = document.getElementById("priceType").value;
			const priceVal = document.getElementById("price").value.trim();
			const introVal = document.getElementById("intro").value.trim();
			const seriesVal = document.getElementById("series").value;
			const prodFormVal = prodFormSelect.value;

			let errors = [];
			if (!prodName) errors.push("· 产品名称为必填项");
			if (!isSignedVal) errors.push("· 「是否签约产品」为必选项");
			if (!priceTypeVal) errors.push("· 价格类型为必选项");
			if (!priceVal) errors.push("· 价格为必填项");
			if (!introVal) errors.push("· 产品简介为必填项");
			if (!seriesVal) errors.push("· 「所属系列」为必选项");
			if (!prodFormVal) errors.push("· 「产品形式」为必选项");

			if (errors.length > 0) {
				validationMessages.innerHTML = errors.join("<br>");
				validationSection.style.display = "block";
			} else {
				validationSection.style.display = "none";
			}

			lastSavedAt = nowTimeString();
			hasUnsavedChanges = false;
			autosaveText.textContent = "最近保存：" + lastSavedAt + "（草稿已保存）";
		});

		// 取消 / 返回
		const cancelBtn = document.getElementById("cancelBtn");
		const backToListBtn = document.getElementById("backToListBtn");
		const stayEditingBtn = document.getElementById("stayEditingBtn");
		const confirmLeaveBtn = document.getElementById("confirmLeaveBtn");

		function handleLeaveAttempt() {
			if (hasUnsavedChanges) {
				openDialog(leaveDialog);
			} else {
				alert("这里模拟「返回产品列表」的行为。实际环境中将跳转到产品列表页。");
			}
		}

		cancelBtn.addEventListener("click", handleLeaveAttempt);
		backToListBtn.addEventListener("click", handleLeaveAttempt);

		stayEditingBtn.addEventListener("click", function () {
			closeDialog(leaveDialog);
		});

		confirmLeaveBtn.addEventListener("click", function () {
			closeDialog(leaveDialog);
			alert("已离开编辑页（原型中仅做提示，不做真实跳转）。");
		});

		// ------------------ 发布逻辑 ------------------
		document.getElementById("publishBtn").addEventListener("click", function () {
			// 发布前先做简单校验
			const prodName = document.getElementById("prodName").value.trim();
			const isSignedVal = document.getElementById("isSigned").value;
			const priceTypeVal = document.getElementById("priceType").value;
			const priceVal = document.getElementById("price").value.trim();
			const introVal = document.getElementById("intro").value.trim();
			const seriesVal = document.getElementById("series").value;
			const prodFormVal = prodFormSelect.value;
			const comboTypeVal = comboTypeSelect.value;

			let errors = [];

			if (!prodName) errors.push("· 产品名称为必填项");
			if (!isSignedVal) errors.push("· 「是否签约产品」为必选项");
			if (!priceTypeVal) errors.push("· 价格类型为必选项");
			if (!priceVal) errors.push("· 价格为必填项");
			if (!introVal) errors.push("· 产品简介为必填项");
			if (!seriesVal) errors.push("· 「所属系列」为必选项");
			if (!prodFormVal) errors.push("· 「产品形式」为必选项");

			// 若是组合策略 + 类型1，则校验权重和
			const isComboType1 = prodFormVal === "combo" && comboTypeVal === "type1";
			if (isComboType1) {
				const isWeightOk = updateWeightSummary();
				if (!isWeightOk) {
					errors.push("· 组合权重总和需为 100%，请在组合详情区调整权重后再发布");
				}
			}

			if (errors.length > 0) {
				validationMessages.innerHTML = errors.join("<br>");
				validationSection.style.display = "block";
			} else {
				validationSection.style.display = "none";
			}

			// 有错误时同样允许打开发布确认弹窗，但在确认时再阻断
			openDialog(publishDialog);
		});

		document.getElementById("cancelPublishBtn").addEventListener("click", function () {
			closeDialog(publishDialog);
		});

		document.getElementById("confirmPublishBtn").addEventListener("click", function () {
			// 再次校验权重和必填
			const prodName = document.getElementById("prodName").value.trim();
			const isSignedVal = document.getElementById("isSigned").value;
			const priceTypeVal = document.getElementById("priceType").value;
			const priceVal = document.getElementById("price").value.trim();
			const introVal = document.getElementById("intro").value.trim();
			const seriesVal = document.getElementById("series").value;
			const prodFormVal = prodFormSelect.value;
			const comboTypeVal = comboTypeSelect.value;

			let errors = [];

			if (!prodName) errors.push("· 产品名称为必填项");
			if (!isSignedVal) errors.push("· 「是否签约产品」为必选项");
			if (!priceTypeVal) errors.push("· 价格类型为必选项");
			if (!priceVal) errors.push("· 价格为必填项");
			if (!introVal) errors.push("· 产品简介为必填项");
			if (!seriesVal) errors.push("· 「所属系列」为必选项");
			if (!prodFormVal) errors.push("· 「产品形式」为必选项");

			const isComboType1 = prodFormVal === "combo" && comboTypeVal === "type1";
			if (isComboType1) {
				const isWeightOk = updateWeightSummary();
				if (!isWeightOk) {
					errors.push("· 组合权重总和需为 100%，当前不满足条件，无法发布");
				}
			}

			if (errors.length > 0) {
				validationMessages.innerHTML = errors.join("<br>");
				validationSection.style.display = "block";
				alert("发布校验未通过，请根据下方提示修正后重试。");
				return;
			}

			// 模拟发布成功
			currentStatus = "published";
			statusText.textContent = "当前状态：已发布";
			statusChip.textContent = "已发布";
			statusChip.className = "status-chip status-published";
			publishWarningBanner.style.display = "none";
			hasUnsavedChanges = false;
			lastSavedAt = nowTimeString();
			autosaveText.textContent = "最近保存：" + lastSavedAt + "（已发布版本）";
			alert("已成功发布该产品（原型中为模拟行为）。");

			closeDialog(publishDialog);
		});

		// ------------------ 监听字段变化标记未保存 ------------------
		const changeFields = document.querySelectorAll(
			"#prodName, #isSigned, #priceType, #price, #discountPrice, #intro, #series, #prodForm, #comboType"
		);
		changeFields.forEach((el) => {
			el.addEventListener("input", markChanged);
			el.addEventListener("change", function () {
				markChanged();
				// 产品形式 / 组合类型联动展示
				handleFormComboVisibility();
			});
		});

		// 产品形式 / 组合类型 联动展示
		function handleFormComboVisibility() {
			const prodFormVal = prodFormSelect.value;
			const comboTypeVal = comboTypeSelect.value;
			const isComboType1 = prodFormVal === "combo" && comboTypeVal === "type1";

			if (prodFormVal === "combo") {
				document.getElementById("comboTypeField").style.display = "block";
			} else {
				document.getElementById("comboTypeField").style.display = "none";
			}

			if (isComboType1) {
				quantBasicSection.style.display = "block";
				comboDetailSection.style.display = "block";
			} else {
				// 其他类型先简单隐藏，具体逻辑可按业务扩展
				quantBasicSection.style.display = "none";
				comboDetailSection.style.display = "none";
			}
		}

		handleFormComboVisibility();

		// ------------------ 编辑组合按钮（仅作为示意） ------------------
		document.getElementById("editLegsBtn").addEventListener("click", function () {
			alert("这里可打开侧滑面板 / 弹窗，新增或移除组合内子策略（原型中仅做提示）。");
		});

		// ------------------ 页面关闭前简单提示（浏览器层，原型可选） ------------------
		window.addEventListener("beforeunload", function (e) {
			if (hasUnsavedChanges) {
				e.preventDefault();
				e.returnValue = "";
			}
		});
	</script>
</body>
</html>
